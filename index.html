<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name=viewport content="width=device-width, initial-scale=1">
<!-- CSS -->
<link rel="stylesheet" href="css/estilo.css" />
<!-- JS -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/iamdustan-smoothscroll/0.4.0/smoothscroll.min.js"></script>
<title>Coronavirus Tracker by Alex Silva</title>
</head>
<!-- Carrega conteúdo -->
<div class="preloader">
  <div class="preloader__content">
    <div class="preloader__loader"></div>
    <div class="preloader__txt">Carregando...</div>
  </div>
</div>
<div class="container">
  <div class="statistics">
    <div class="global">
      <div class="global__title">
        Corona Virus Tracker
      </div>
      <div class="global__cases">
        <h1></h1>
        <h2>Total de casos</h2>
      </div>
      <div class="global__deaths">
        <h1></h1>
        <h2>Total de mortes</h2>
      </div>
      <div class="global__recovered">
        <h1></h1>
        <h2>Total de curados</h2>
      </div>
    </div>
    <input type="text" id="search" name="country" placeholder="Pesquisar países">
    <select class="custom-select" id="select" onchange="changeOrder()">
      <option selected="" disabled="">Ordenar por</option>
      <option value="cases">Total de casos</option>
      <option value="deaths">Total de mortes</option>
      <option value="recovered">Total de curados</option>
    </select>
    <table class="table">
      <thead>
        <tr>
          <th>País</th>
          <th>Casos</th>
          <th>Mortes</th>
          <th>Curados</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
  <div class="arrow">
    <div class="arrow__up">
    </div>
    <div class="arrow__down">
    </div>
  </div>
</div>
 <!-- SCRIPT -->
 <script type="text/javascript">
// Adiciona um interceptador de solicitações
axios.interceptors.request.use(
    function (config) {
      console.log("solicitação enviada", new Date());
      return config;
    },
    function (error) {
      preloader.classList.add("preloader--hidden");
      alert(error);
      return Promise.reject(error);
    }
  );
  
  var preloader = document.querySelector(".preloader");
  
  // Adiciona um interceptador da resposta
  axios.interceptors.response.use(
    function (response) {
      preloader.classList.add("preloader--hidden");
      return response;
    },
    function (error) {
      preloader.classList.add("preloader--hidden");
      alert(error);
      return Promise.reject(error);
    }
  );
  /// Lista de dados Global
  function getGlobalData() {
    return axios.get("https://corona.lmao.ninja/all");
  }
  /// Lista de países em JSON
  function getCountriesData() {
    return axios.get("https://corona.lmao.ninja/countries");
  }
  
  axios
    .all([getGlobalData(), getCountriesData()])
    .then(
      axios.spread(function (global, countries) {
        //Global logs
        console.log("%c Global", "color: #fb5e53");
        console.log("Casos", global.data.cases);
        console.log("Mortes", global.data.deaths);
        console.log("Curados", global.data.recovered);
  
        var totalCases = global.data.cases.toLocaleString();
        var totalDeaths = global.data.deaths.toLocaleString();
        var totalRecovered = global.data.recovered.toLocaleString();
  
        document.getElementsByClassName(
          "global__cases"
        )[0].childNodes[1].innerHTML = totalCases;
        document.getElementsByClassName(
          "global__recovered"
        )[0].childNodes[1].innerHTML = totalRecovered;
        document.getElementsByClassName(
          "global__deaths"
        )[0].childNodes[1].innerHTML = totalDeaths;
  
        // Países
        const tbody = document.getElementsByTagName("tbody")[0];
        var countries = countries.data;
        countries.forEach(function (element, index, array) {
          const tr = document.createElement("tr");
          // Bandeira
          const img = document.createElement("img");
          img.src = element.countryInfo.flag;
          img.alt = element.countryInfo.iso2;
          img.setAttribute("title", element.countryInfo.iso2);
          var values = [
            element.country,
            element.cases,
            element.deaths,
            element.recovered
          ];
          values.forEach(function (element, index, array) {
            const td = document.createElement("td");
            element =
              validation.isNumber(element) === "NaN"
                ? element
                : element.toLocaleString();
            if (!index) {
              let text = document.createTextNode(element);
              td.appendChild(img);
              td.appendChild(text);
            } else {
              td.innerHTML = element;
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      })
    )
    .catch(function (error) {
      console.log(error);
    });
  
  var validation = {
    isNumber: function (str) {
      //  /^\d+$/g é igual a /^[0-9]+$/g;
      var patt = /^\d+$/g;
      return patt.test(str);
    }
  };
  
  var search = document.getElementById("search");
  search.addEventListener("keyup", function () {
    var value = this.value.toLowerCase();
    console.log("value", value);
    const rows = document.querySelectorAll("tbody tr");
    const rowsArray = Array.prototype.slice.call(rows);
    rowsArray.forEach(function (element, index, array) {
      var tdCountry = element.childNodes[0].innerHTML.toLowerCase();
      if (tdCountry.indexOf(value) > -1) {
        //console.log(tdCountry, tdCountry.indexOf(value));
        element.classList.remove("hidden");
      } else {
        element.classList.add("hidden");
      }
    });
  });
  
  function changeOrder() {
    const value = document.getElementById("select").value;
    const index = document.getElementById("select").selectedIndex;
    //console.log(value, index);
    const rows = document.querySelectorAll("tbody tr");
    const rowsArray = Array.prototype.slice.call(rows);
    rowsArray
      .sort(function (A, B) {
        var num1 = A.childNodes[index].innerHTML;
        num1 = num1.replace(",", "");
        var num2 = B.childNodes[index].innerHTML;
        num2 = num2.replace(",", "");
        return num2 - num1;
      })
      .forEach(function (tr) {
        tr.parentElement.appendChild(tr);
      });
    //console.log(rowsArray);
  }
  document.querySelector(".arrow__up").addEventListener("click", function () {
    window.scrollTo({
      top: 0,
      behavior: "smooth"
    });
  });
  
  document.querySelector(".arrow__down").addEventListener("click", function () {
    window.scrollTo({
      top: document.body.scrollHeight,
      behavior: "smooth"
    });
  });
 </script>
</html>
